library(vrcmort)

# 1) Simulate data
sim <- vrc_simulate(T = 96, t0 = 40, seed = 123)

# Optional: diagnose reporting artefacts before fitting
diag <- vrc_diagnose_reporting(sim$df_obs, t0 = sim$meta$t0)
diag$plots$by_cause

# 2) Build Stan data and fit
fit <- vrc_fit(
  data = sim$df_obs,
  t0 = sim$meta$t0,
  mortality_covariates = ~ facility,   # example
  reporting_covariates = ~ facility,   # example
  algorithm = "sampling",
  chains = 4,
  iter = 1000,
  seed = 123
)

# Or, using the high-level interface:
mort <- vrc_mortality(~ facility)
rep <- vrc_reporting(~ facility)

# Optional: allow the conflict effect to vary by region (partial pooling)
# and add region-specific time trends around the national random walk.
# This can help prevent spurious "conflict reduces mortality" artefacts when
# reporting collapses differently across regions.
mort2 <- vrc_mortality(~ facility, conflict = "region", time = "region")
rep2  <- vrc_reporting(~ facility, conflict = "region", time = "region")

fit2 <- vrcm(
  mortality = mort,
  reporting = rep,
  data = sim$df_obs,
  t0 = sim$meta$t0,
  chains = 4,
  iter = 1000,
  seed = 123
)

fit3 <- vrcm(
  mortality = mort2,
  reporting = rep2,
  data = sim$df_obs,
  t0 = sim$meta$t0,
  chains = 4,
  iter = 1000,
  seed = 123
)

# 3) Summarise and plot reporting completeness
summary(fit0)
plot_reporting(fit0)
