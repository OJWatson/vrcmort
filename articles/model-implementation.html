<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Model Implementation • vrcmort</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Model Implementation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">vrcmort</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="nav-link" href="https://github.com/OJWatson/vrcmort/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Model Implementation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/OJWatson/vrcmort/blob/main/vignettes/model-implementation.Rmd"><code>vignettes/model-implementation.Rmd</code></a></small>
      <div class="d-none name"><code>model-implementation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette explains how <code>vrcmort</code> turns a VR long table
into a Stan model fit.</p>
<p>The package follows an epidemia-like pattern:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Validate and index the data</strong> into integer indices
(region, time, age, sex, cause).</li>
<li>
<strong>Construct design matrices</strong> from user-provided
formulas.</li>
<li>
<strong>Build a Stan data list</strong> that also contains prior
hyperparameters.</li>
<li>
<strong>Fit the model</strong> via Stan (HMC via
<code>rstan</code>).</li>
</ol>
<p>The goal is that most users never need to edit Stan, while advanced
users can still do so.</p>
</div>
<div class="section level2">
<h2 id="canonical-vr-long-format">Canonical VR long format<a class="anchor" aria-label="anchor" href="#canonical-vr-long-format"></a>
</h2>
<p>The core fitting functions expect one row per cell. Columns are:</p>
<ul>
<li>identifiers: <code>region</code>, <code>time</code>,
<code>age</code>, <code>sex</code>, <code>cause</code>
</li>
<li>outcome: <code>y</code> (observed VR deaths)</li>
<li>denominator: <code>exposure</code> (person-time at risk)</li>
<li>conflict covariate: <code>conflict</code>
</li>
<li>any additional covariates referenced in formulas</li>
</ul>
<p>You can check the recommended contract with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vrc_canonical_columns.html">vrc_canonical_columns</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="building-vr-long-data-from-individual-records">Building VR long data from individual records<a class="anchor" aria-label="anchor" href="#building-vr-long-data-from-individual-records"></a>
</h3>
<p>If you have individual-level deaths with region, month, age, sex, and
ICD-10 codes, the typical workflow is:</p>
<ol style="list-style-type: decimal">
<li>classify ICD-10 into a small cause grouping (for example trauma vs
non-trauma),</li>
<li>bin ages into groups,</li>
<li>aggregate counts by
<code>(region, time, age, sex, cause)</code>,</li>
<li>join population and covariates, and compute exposure.</li>
</ol>
<p>The tutorial vignette <em>Data preparation from individual VR
records</em> contains a worked template.</p>
</div>
</div>
<div class="section level2">
<h2 id="validation-and-indexing">Validation and indexing<a class="anchor" aria-label="anchor" href="#validation-and-indexing"></a>
</h2>
<p>Before fitting, <code>vrcmort</code> can validate common
pitfalls:</p>
<ul>
<li>duplicated cells,</li>
<li>negative or non-integer counts,</li>
<li>missing exposure,</li>
<li>likely “missing-as-zero” pipelines.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vrc_validate_data.html">vrc_validate_data</a></span><span class="op">(</span><span class="va">vr_long</span><span class="op">)</span></span></code></pre></div>
<p>Then the package maps your identifiers to integer indices needed by
Stan:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrc_index.html">vrc_index</a></span><span class="op">(</span><span class="va">vr_long</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">idx</span><span class="op">$</span><span class="va">meta</span><span class="op">)</span></span></code></pre></div>
<p>The <code>meta</code> object stores levels and dimensions, and is
returned in fitted objects.</p>
</div>
<div class="section level2">
<h2 id="formulas-and-design-matrices">Formulas and design matrices<a class="anchor" aria-label="anchor" href="#formulas-and-design-matrices"></a>
</h2>
<p>The Stan model always includes the conflict proxy in both the
mortality and reporting submodels.</p>
<p>User-supplied formulas specify <strong>additional</strong> covariates
beyond conflict.</p>
<p>For example:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mort</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrc_mortality.html">vrc_mortality</a></span><span class="op">(</span><span class="op">~</span> <span class="va">facility</span> <span class="op">+</span> <span class="va">food_insecurity</span><span class="op">)</span></span>
<span><span class="va">rep</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrc_reporting.html">vrc_reporting</a></span><span class="op">(</span><span class="op">~</span> <span class="va">facility</span><span class="op">)</span></span></code></pre></div>
<p>Internally:</p>
<ul>
<li>
<code><a href="../reference/vrc_standata.html">vrc_standata()</a></code> builds <code>X_mort</code> and
<code>X_rep</code> using <code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code>.</li>
<li>covariates are (by default) centred and scaled.</li>
<li>the scaling information is stored in the fitted object so that
coefficients can be reported on the original scale if desired.</li>
</ul>
<div class="section level3">
<h3 id="structured-options-partial-pooling-and-region-specific-trends">Structured options (partial pooling and region-specific trends)<a class="anchor" aria-label="anchor" href="#structured-options-partial-pooling-and-region-specific-trends"></a>
</h3>
<p>The component constructors also control optional structured
features:</p>
<ul>
<li>
<code>conflict = "fixed"</code> or <code>"region"</code> for
region-varying conflict effects,</li>
<li>
<code>time = "national"</code> or <code>"region"</code> for
region-specific time random walk deviations.</li>
</ul>
<p>These are passed to Stan as boolean flags:</p>
<ul>
<li><code>use_beta_conf_re</code></li>
<li><code>use_gamma_conf_re</code></li>
<li><code>use_rw_region_lambda</code></li>
<li><code>use_rw_region_rho</code></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="building-stan-data">Building Stan data<a class="anchor" aria-label="anchor" href="#building-stan-data"></a>
</h2>
<p>To see what is passed to Stan without fitting, set
<code>chains = 0</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">standata_bundle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrcm.html">vrcm</a></span><span class="op">(</span></span>
<span>  mortality <span class="op">=</span> <span class="va">mort</span>,</span>
<span>  reporting <span class="op">=</span> <span class="va">rep</span>,</span>
<span>  data <span class="op">=</span> <span class="va">vr_long</span>,</span>
<span>  t0 <span class="op">=</span> <span class="va">conflict_start_month</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">standata_bundle</span><span class="op">$</span><span class="va">standata</span><span class="op">)</span></span></code></pre></div>
<p>This returns a list that contains:</p>
<ul>
<li>
<code>standata</code>: the full Stan data list,</li>
<li>
<code>meta</code>: dimensions and factor levels,</li>
<li>
<code>scaling</code>: centring and scaling applied to
covariates.</li>
</ul>
</div>
<div class="section level2">
<h2 id="priors-as-data">Priors as data<a class="anchor" aria-label="anchor" href="#priors-as-data"></a>
</h2>
<p>A key design decision in <code>vrcmort</code> is that priors are
provided to Stan as data.</p>
<p>This means you can change priors without editing Stan files.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pri</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrc_priors.html">vrc_priors</a></span><span class="op">(</span></span>
<span>  beta_conf <span class="op">=</span> <span class="fu"><a href="../reference/normal.html">normal</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>  gamma_conf <span class="op">=</span> <span class="fu"><a href="../reference/normal.html">normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  beta_mort <span class="op">=</span> <span class="fu"><a href="../reference/normal.html">normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, autoscale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  gamma_rep <span class="op">=</span> <span class="fu"><a href="../reference/normal.html">normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.7</span>, autoscale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrcm.html">vrcm</a></span><span class="op">(</span></span>
<span>  mortality <span class="op">=</span> <span class="va">mort</span>,</span>
<span>  reporting <span class="op">=</span> <span class="va">rep</span>,</span>
<span>  data <span class="op">=</span> <span class="va">vr_long</span>,</span>
<span>  t0 <span class="op">=</span> <span class="va">conflict_start_month</span>,</span>
<span>  priors <span class="op">=</span> <span class="va">pri</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/vrc_prior_summary.html">vrc_prior_summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<p>The prior vignette explains how each prior maps to the model
parameters.</p>
</div>
<div class="section level2">
<h2 id="stan-model-layout">Stan model layout<a class="anchor" aria-label="anchor" href="#stan-model-layout"></a>
</h2>
<p>The Stan code in <code>inst/stan/</code> is split into modular
include files (“lego bricks”):</p>
<ul>
<li>
<code>functions/</code>: reusable helper functions (for example RW1
construction)</li>
<li>
<code>data/</code>: the data block, including prior
hyperparameters</li>
<li>
<code>parameters/</code>: parameter declarations</li>
<li>
<code>tparameters/</code>: transformed parameters (linear
predictors, expected mean)</li>
<li>
<code>model/</code>: priors and likelihood</li>
<li>
<code>generated_quantities/</code>: posterior predictive draws,
pointwise log-likelihood</li>
</ul>
<p>The top-level model file <code>vr_reporting_model.stan</code> mostly
consists of <code>#include</code> statements.</p>
<p>This makes it easier to create alternative variants (for example
adding misclassification) while keeping the same R interface.</p>
</div>
<div class="section level2">
<h2 id="fitting-via-rstan">Fitting via rstan<a class="anchor" aria-label="anchor" href="#fitting-via-rstan"></a>
</h2>
<p>Model fitting uses Hamiltonian Monte Carlo (HMC) as implemented in
Stan. The main user controls are:</p>
<ul>
<li>
<code>chains</code>, <code>iter</code>, <code>seed</code>
</li>
<li>
<code>adapt_delta</code>, <code>max_treedepth</code>
</li>
</ul>
<p>If you have difficult geometry (common in hierarchical models with
weak identifiability), increasing <code>adapt_delta</code> is often
helpful.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrcm.html">vrcm</a></span><span class="op">(</span></span>
<span>  mortality <span class="op">=</span> <span class="va">mort</span>,</span>
<span>  reporting <span class="op">=</span> <span class="va">rep</span>,</span>
<span>  data <span class="op">=</span> <span class="va">vr_long</span>,</span>
<span>  t0 <span class="op">=</span> <span class="va">conflict_start_month</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  adapt_delta <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  max_treedepth <span class="op">=</span> <span class="fl">12</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="outputs">Outputs<a class="anchor" aria-label="anchor" href="#outputs"></a>
</h2>
<p>A fitted model (<code>vrcfit</code>) stores:</p>
<ul>
<li>the underlying <code>rstan</code> fit</li>
<li>the <code>standata</code> used</li>
<li>the <code>meta</code> indexing information</li>
</ul>
<p>Common post-processing helpers include:</p>
<ul>
<li>
<code><a href="../reference/posterior_reporting.html">posterior_reporting()</a></code> for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mspace width="0.167em"></mspace><mi>ρ</mi></mrow><annotation encoding="application/x-tex">\,\rho</annotation></semantics></math>
</li>
<li>
<code><a href="../reference/posterior_mortality.html">posterior_mortality()</a></code> for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mspace width="0.167em"></mspace><mi>λ</mi></mrow><annotation encoding="application/x-tex">\,\lambda</annotation></semantics></math>
</li>
<li>
<code><a href="../reference/posterior_expected_counts.html">posterior_expected_counts()</a></code> for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>μ</mi><annotation encoding="application/x-tex">\mu</annotation></semantics></math>
</li>
<li>
<code><a href="../reference/plot_reporting.html">plot_reporting()</a></code> and <code><a href="../reference/plot_mortality.html">plot_mortality()</a></code>
</li>
</ul>
<p>For model comparison, the generated quantities include pointwise
<code>log_lik</code>, which can be used with the <code>loo</code>
package.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by OJ Watson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
