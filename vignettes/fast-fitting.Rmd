---
title: "Fast Fitting Strategies"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fast Fitting Strategies}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)

rstan::rstan_options(auto_write = TRUE)
options(mc.cores = 1L)
```

This vignette explores practical ways to make `vrcmort` fits faster, focusing on the no-covariate setting (`~ 1`) and small examples that run quickly.

## Simulate a tiny example

We use a deliberately small dataset:

- 3 regions
- 10 time points
- conflict begins at time 6 (5 pre, 5 post)
- 5 age groups

```{r}
library(vrcmort)

sim_fast <- vrc_simulate(
  R = 3,
  T = 10,
  t0 = 6,
  age_breaks = c(0, 5, 15, 35, 65, Inf),
  seed = 123,
  missing = list(type = "none"),
  rho0_true = c(0.99, 0.99)
)

df <- sim_fast$df_obs

head(df)
```

```{r}
# Standata dimensions for reference
sd <- vrc_fit(
  data = df,
  t0 = sim_fast$meta$t0,
  chains = 0
)

sd$meta
c(N = sd$standata$N, R = sd$standata$R, T = sd$standata$T, A = sd$standata$A, S = sd$standata$S, G = sd$standata$G)
```

## Switches we will benchmark

We benchmark four expensive/optional components:

- **A**: region-specific time random-walk deviations (`time = "region"` vs `"national"`)
- **B**: region-varying conflict slopes (`conflict = "region"` vs `"fixed"`)
- **C**: pre-conflict reporting estimated vs fixed to 1 (`pre_conflict_reporting = "estimate"` vs `"fixed1"`)
- **D**: generated quantities enabled vs disabled (`generated_quantities = "full"` vs `"none"`)

These options are all switchable via the high-level interface.

## Benchmark: six runs

We run exactly six fits:

- full model (A+B+C+D enabled)
- quickest model (A+B+C+D disabled)
- full model minus one component: -A, -B, -C, -D

```{r}
run_one <- function(label,
                    mort,
                    rep,
                    pre_conflict_reporting,
                    generated_quantities,
                    iter = 200,
                    chains = 1,
                    seed = 123) {
  cat("\n\n---\n")
  cat(label, "\n")
  tm <- system.time({
    fit <- vrcm(
      mortality = mort,
      reporting = rep,
      data = df,
      t0 = sim_fast$meta$t0,
      pre_conflict_reporting = pre_conflict_reporting,
      generated_quantities = generated_quantities,
      chains = chains,
      iter = iter,
      seed = seed,
      refresh = 0
    )
  })
  print(fit)
  gc()
  data.frame(
    model = label,
    elapsed_seconds = unname(tm["elapsed"]),
    row.names = NULL,
    stringsAsFactors = FALSE
  )
}

mort_full <- vrc_mortality(~ 1, conflict = "region", time = "region")
rep_full  <- vrc_reporting(~ 1, conflict = "region", time = "region")

mort_fast <- vrc_mortality(~ 1, conflict = "fixed", time = "national")
rep_fast  <- vrc_reporting(~ 1, conflict = "fixed", time = "national")

r_full <- run_one(
  "full (A+B+C+D)",
  mort = mort_full,
  rep = rep_full,
  pre_conflict_reporting = "estimate",
  generated_quantities = "full"
)

r_quick <- run_one(
  "quickest (-A-B-C-D)",
  mort = mort_fast,
  rep = rep_fast,
  pre_conflict_reporting = "fixed1",
  generated_quantities = "none"
)

r_minus_A <- run_one(
  "full - A (no region time deviations)",
  mort = vrc_mortality(~ 1, conflict = "region", time = "national"),
  rep = vrc_reporting(~ 1, conflict = "region", time = "national"),
  pre_conflict_reporting = "estimate",
  generated_quantities = "full"
)

r_minus_B <- run_one(
  "full - B (fixed conflict slopes)",
  mort = vrc_mortality(~ 1, conflict = "fixed", time = "region"),
  rep = vrc_reporting(~ 1, conflict = "fixed", time = "region"),
  pre_conflict_reporting = "estimate",
  generated_quantities = "full"
)

r_minus_C <- run_one(
  "full - C (pre-conflict rho fixed to 1)",
  mort = mort_full,
  rep = rep_full,
  pre_conflict_reporting = "fixed1",
  generated_quantities = "full"
)

r_minus_D <- run_one(
  "full - D (no generated quantities)",
  mort = mort_full,
  rep = rep_full,
  pre_conflict_reporting = "estimate",
  generated_quantities = "none"
)

runtime <- rbind(r_full, r_quick, r_minus_A, r_minus_B, r_minus_C, r_minus_D)
runtime
```
